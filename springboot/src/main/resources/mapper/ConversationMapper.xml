<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cy.mapper.ConversationMapper">

    <select id="listConversation" resultType="com.alibaba.fastjson2.JSONObject">
        SELECT
        c.cid as cid,
        c.last_message_content as lastMessageContent,
        c.last_message_send_time as lastMessageTime,
        0 as unreadCount,

        -- 对方用户详细信息
        u.nickname as otherUserNickname,
        u.avatar as otherUserAvatar

        FROM conversation c
        INNER JOIN `order` o ON c.oid = o.oid
        LEFT JOIN user u ON (
        -- 关联对方用户信息
        (o.xdr = #{uid} AND u.uid = o.jdr) OR -- 当前用户是下单人，关联接单人
        (o.jdr = #{uid} AND u.uid = o.xdr) -- 当前用户是接单人，关联下单人
        )
        WHERE
        -- 用户必须是订单的下单人 或 接单人
        (o.xdr = #{uid} OR o.jdr = #{uid})
        -- 会话状态是开启的
        AND c.status = 'OPENING'
        ORDER BY c.last_message_send_time DESC
    </select>
</mapper>